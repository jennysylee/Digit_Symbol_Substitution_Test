<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digit Symbol Substitution Test</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transpilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background-color: #f1eedf; 
            overflow-x: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        }
        .no-select { user-select: none; }
        @keyframes pulse-custom {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(1.1); }
        }
        .animate-pulse-slow { animation: pulse-custom 3s infinite ease-in-out; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- CONSTANTS ---
        const TEST_DURATION = 120000;
        const TRAINING_TRIALS = 3;

        const SYMBOLS = [
            (props) => <svg viewBox="0 0 100 100" className="w-full h-full" {...props}><path d="M20,20 L80,80 M80,20 L20,80" stroke="currentColor" strokeWidth="8" fill="none"/></svg>,
            (props) => <svg viewBox="0 0 100 100" className="w-full h-full" {...props}><circle cx="50" cy="50" r="30" fill="none" stroke="currentColor" strokeWidth="8"/></svg>,
            (props) => <svg viewBox="0 0 100 100" className="w-full h-full" {...props}><rect x="25" y="25" width="50" height="50" fill="none" stroke="currentColor" strokeWidth="8"/></svg>,
            (props) => <svg viewBox="0 0 100 100" className="w-full h-full" {...props}><path d="M50,20 L80,80 L20,80 Z" fill="none" stroke="currentColor" strokeWidth="8"/></svg>,
            (props) => <svg viewBox="0 0 100 100" className="w-full h-full" {...props}><path d="M20,50 L80,50 M50,20 L50,80" stroke="currentColor" strokeWidth="8" fill="none"/></svg>,
            (props) => <svg viewBox="0 0 100 100" className="w-full h-full" {...props}><path d="M20,20 Q50,80 80,20" fill="none" stroke="currentColor" strokeWidth="8"/></svg>,
            (props) => <svg viewBox="0 0 100 100" className="w-full h-full" {...props}><path d="M20,20 L80,20 L50,80 Z" fill="none" stroke="currentColor" strokeWidth="8"/></svg>,
            (props) => <svg viewBox="0 0 100 100" className="w-full h-full" {...props}><path d="M50,10 L50,90 M10,50 L90,50 M20,20 L80,80 M80,20 L20,80" stroke="currentColor" strokeWidth="4" fill="none"/></svg>,
            (props) => <svg viewBox="0 0 100 100" className="w-full h-full" {...props}><rect x="20" y="40" width="60" height="20" rx="10" fill="none" stroke="currentColor" strokeWidth="8"/></svg>
        ];

        // --- UTILS ---
        const shuffle = (array) => {
            const newArr = [...array];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        };

        const generateStimuli = (count) => {
            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(Math.floor(Math.random() * 9) + 1);
            }
            return result;
        };

        // --- COMPONENTS ---
        const DigitSymbolKey = ({ mapping }) => (
            <div className="flex justify-center gap-2 mb-8 bg-white p-4 rounded-xl shadow-md border-2 border-slate-200">
                {[1, 2, 3, 4, 5, 6, 7, 8, 9].map((digit) => {
                    const symbolIdx = mapping.indexOf(digit);
                    const SymbolComp = SYMBOLS[symbolIdx];
                    return (
                        <div key={digit} className="flex flex-col items-center w-12 border-x first:border-l-0 last:border-r-0 border-slate-100">
                            <span className="text-xl font-bold text-slate-700 mb-1">{digit}</span>
                            <div className="w-8 h-8 text-slate-600">
                                <SymbolComp />
                            </div>
                        </div>
                    );
                })}
            </div>
        );

        const App = () => {
            const [appState, setAppState] = useState('INSTRUCTIONS');
            const [mapping, setMapping] = useState([]);
            const [bottomSymbols, setBottomSymbols] = useState([]);
            const [stimuli, setStimuli] = useState([]);
            const [stimuliIndex, setStimuliIndex] = useState(0);
            const [results, setResults] = useState([]);
            const [countdown, setCountdown] = useState(5);
            const [timeLeft, setTimeLeft] = useState(TEST_DURATION / 1000);
            const [errorFeedback, setErrorFeedback] = useState(null);
            
            const startTimeRef = useRef(0);
            const lastTrialTimeRef = useRef(0);
            const timerIntervalRef = useRef(null);

            const resetApp = () => {
                if (timerIntervalRef.current) clearInterval(timerIntervalRef.current);
                setResults([]);
                setStimuliIndex(0);
                setTimeLeft(TEST_DURATION / 1000);
                setErrorFeedback(null);
                setAppState('INSTRUCTIONS');
            };

            const startSession = () => {
                const digits = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                const randomizedDigits = shuffle(digits);
                setMapping(randomizedDigits);
                setBottomSymbols(shuffle([0, 1, 2, 3, 4, 5, 6, 7, 8]));
                setStimuli(generateStimuli(500));
                setAppState('COUNTDOWN');
                setCountdown(5);
            };

            useEffect(() => {
                if (appState === 'COUNTDOWN') {
                    if (countdown > 0) {
                        const timer = setTimeout(() => setCountdown(countdown - 1), 1000);
                        return () => clearTimeout(timer);
                    } else {
                        setAppState('TESTING');
                        startTimeRef.current = Date.now();
                        lastTrialTimeRef.current = Date.now();
                    }
                }
            }, [appState, countdown]);

            useEffect(() => {
                if (appState === 'TESTING') {
                    timerIntervalRef.current = window.setInterval(() => {
                        const elapsed = Date.now() - startTimeRef.current;
                        const remaining = Math.max(0, (TEST_DURATION - elapsed) / 1000);
                        setTimeLeft(remaining);
                        if (remaining <= 0) {
                            if (timerIntervalRef.current) clearInterval(timerIntervalRef.current);
                            setAppState('FEEDBACK');
                        }
                    }, 100);
                    return () => { if (timerIntervalRef.current) clearInterval(timerIntervalRef.current); };
                }
            }, [appState]);

            const handleSymbolClick = (symbolIdx) => {
                if (appState !== 'TESTING') return;
                const clickedDigit = mapping[symbolIdx];
                const targetDigit = stimuli[stimuliIndex];
                const now = Date.now();
                const rt = now - lastTrialTimeRef.current;

                if (clickedDigit === targetDigit) {
                    if (stimuliIndex >= TRAINING_TRIALS) {
                        setResults(prev => [...prev, { digit: targetDigit, rt, correct: true, timestamp: now }]);
                    }
                    setStimuliIndex(prev => prev + 1);
                    lastTrialTimeRef.current = now;
                    setErrorFeedback(null);
                } else {
                    setErrorFeedback(symbolIdx);
                    setTimeout(() => setErrorFeedback(null), 500);
                    if (stimuliIndex >= TRAINING_TRIALS) {
                        setResults(prev => [...prev, { digit: targetDigit, rt, correct: false, timestamp: now }]);
                    }
                }
            };

            const downloadCSV = () => {
                const headers = ['trial_index', 'target_digit', 'reaction_time_ms', 'is_correct', 'timestamp_iso'];
                const rows = results.map((r, i) => [i + 1, r.digit, r.rt, r.correct, new Date(r.timestamp).toISOString()]);
                const csvContent = [headers, ...rows].map(e => e.join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `dsst_results_${Date.now()}.csv`);
                link.click();
            };

            if (appState === 'INSTRUCTIONS') return (
                <div className="max-w-2xl bg-white p-8 rounded-2xl shadow-2xl border border-slate-200 m-4">
                    <h1 className="text-3xl font-black text-slate-800 mb-6 text-center">Digit Symbol Substitution Test</h1>
                    <div className="space-y-4 text-slate-600 text-lg leading-relaxed">
                        <p>A test of processing speed and association.</p>
                        <ul className="list-disc list-inside space-y-2">
                            <li>Top: Key matching <strong>Digits (1-9)</strong> to <strong>Symbols</strong>.</li>
                            <li>Middle: Highlighted <strong>Target Digit</strong>.</li>
                            <li>Bottom: Click the <strong>Matching Symbol</strong>.</li>
                        </ul>
                        <p className="italic bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-yellow-800">Practice trials first.</p>
                    </div>
                    <button onClick={startSession} className="w-full mt-8 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition-all shadow-lg">START</button>
                </div>
            );

            if (appState === 'COUNTDOWN') return (
                <div className="text-center">
                    <h2 className="text-6xl font-black text-slate-400 mb-4 uppercase tracking-widest">Starting</h2>
                    <div className="text-9xl font-black text-blue-600 animate-bounce">{countdown}</div>
                </div>
            );

            if (appState === 'TESTING') {
                const isTraining = stimuliIndex < TRAINING_TRIALS;
                const targetDigit = stimuli[stimuliIndex];
                return (
                    <div className="flex flex-col items-center w-full max-w-4xl no-select p-4">
                        <div className="w-full flex justify-between items-center mb-6">
                            <div className={`px-4 py-1 rounded-full text-sm font-bold ${isTraining ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'}`}>
                                {isTraining ? 'PRACTICE' : 'TESTING'}
                            </div>
                            <div className="text-2xl font-mono font-bold text-slate-700 bg-white px-4 py-2 rounded shadow-inner">
                                {Math.floor(timeLeft / 60)}:{(timeLeft % 60).toFixed(1).padStart(4, '0')}
                            </div>
                        </div>
                        <DigitSymbolKey mapping={mapping} />
                        <div className="relative w-full h-48 flex items-center justify-center bg-white rounded-2xl shadow-inner border-4 border-slate-100 mb-12">
                            <div className="relative w-24 h-24 bg-yellow-100 border-4 border-yellow-400 rounded-2xl flex items-center justify-center shadow-lg">
                                <span className="text-5xl font-black text-yellow-900">{targetDigit}</span>
                            </div>
                        </div>
                        <div className="grid grid-cols-3 sm:grid-cols-9 gap-4 w-full">
                            {bottomSymbols.map((sIdx) => {
                                const SymbolIcon = SYMBOLS[sIdx];
                                return (
                                    <button key={sIdx} onClick={() => handleSymbolClick(sIdx)} className={`relative aspect-square rounded-xl flex items-center justify-center p-3 shadow-md transition-all border-2 ${errorFeedback === sIdx ? 'bg-red-500 border-red-600 scale-95' : 'bg-white border-white hover:border-blue-400 active:scale-90'}`}>
                                        <div className={errorFeedback === sIdx ? 'text-white' : 'text-slate-700'}><SymbolIcon /></div>
                                        {errorFeedback === sIdx && <div className="absolute inset-0 flex items-center justify-center text-white text-4xl font-bold">âœ•</div>}
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                );
            }

            if (appState === 'FEEDBACK') {
                const totalCorrect = results.filter(r => r.correct).length;
                return (
                    <div className="max-w-3xl w-full bg-white p-10 rounded-3xl shadow-2xl border border-slate-100 flex flex-col items-center m-4">
                        <h2 className="text-4xl font-black text-slate-800 mb-8">Results</h2>
                        <div className="text-6xl font-black text-blue-600 mb-8">{totalCorrect} Correct</div>
                        <button onClick={downloadCSV} className="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl mb-4">DOWNLOAD CSV</button>
                        <button onClick={resetApp} className="w-full bg-slate-100 text-slate-800 font-bold py-4 rounded-xl">RESTART</button>
                    </div>
                );
            }
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
